---
- name: Manage NPS RADIUS client (single action) over SSH
  hosts: all
  gather_facts: no

  vars:
    # SSH Connection settings for Windows
    ansible_connection: ssh
    ansible_user: "ansible-ssh"
    ansible_password: "Mission1990$"
    ansible_port: 22
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
    ansible_ssh_retries: 3

    # Critical Windows SSH settings
    ansible_shell_type: cmd  # Use cmd instead of powershell for initial shell
    ansible_shell_executable: cmd.exe

    # For privilege escalation if needed
    ansible_become_method: runas
    ansible_become_user: "{{ ansible_user }}"

    # Normalize survey inputs
    action_name: "{{ action_name | lower | trim }}"
    radius_client: "{{ radius_client | trim }}"
    ip_address: "{{ ip_address | default('') | trim }}"
    radius_vendor: "{{ radius_vendor | default('RADIUS Standard') | trim }}"

  tasks:
    - name: Validate action_name
      assert:
        that:
          - action_name in ['create', 'update', 'delete']
        fail_msg: "action_name must be one of: create, update, delete"

    - name: Validate required fields based on action
      assert:
        that:
          - radius_client != ''
          - action_name == 'delete' or ip_address != ''
          - action_name == 'delete' or (radius_secret is defined and (radius_secret | string | length) > 0)
        fail_msg: >
          Missing required fields. create/update require radius_client, ip_address, radius_secret.
          delete requires radius_client only.

<<<<<<< HEAD
    # Test connection first
    - name: Test PowerShell availability
      raw: powershell.exe -NoProfile -NonInteractive -Command "Write-Output 'PowerShell Ready'"
      register: ps_test
      changed_when: false
      failed_when: false

    - name: Debug PowerShell test
      debug:
        var: ps_test
      when: ps_test.rc != 0
=======
    # # Optional: prove PowerShell can run over SSH (useful for troubleshooting)
    # - name: Confirm PowerShell execution over SSH
    #   ansible.windows.win_shell: >
    #     powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    #     "$PSVersionTable.PSVersion.ToString()"
    #   register: ps_version
    #   changed_when: false

    # - name: Show PowerShell version
    #   debug:
    #     var: ps_version.stdout
>>>>>>> a08f3fd (Hashout Powershell confirmation)

    - name: Apply NPS action (create/update/delete) - Using raw module for Windows SSH
      raw: |
        powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command "& {
          $ErrorActionPreference = 'Stop';

          $Name   = '{{ radius_client }}';
          $Action = '{{ action_name }}';
          $IP     = '{{ ip_address }}';
          $Secret = '{{ radius_secret | default('') }}';
          $Vendor = '{{ radius_vendor }}';

          function New-Client {
            param($Name,$IP,$Secret,$Vendor)

            if ([string]::IsNullOrWhiteSpace($Vendor) -or $Vendor -eq 'RADIUS Standard') {
              New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret | Out-Null
            } else {
              New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -VendorName $Vendor | Out-Null
            }
          }

          try {
            Import-Module NPS -ErrorAction Stop
          } catch {
            Write-Output 'ERROR: NPS module not available. Is NPS role installed?'
            exit 1
          }

          $existing = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue

          switch ($Action) {
            'create' {
              if ($existing) {
                Write-Output ('EXISTS_NO_CHANGE: ' + $Name)
                exit 0
              }

              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor
              Write-Output ('CREATED: ' + $Name + ' (' + $IP + ')')
              exit 0
            }

            'update' {
              if (-not $existing) {
                Write-Output ('MISSING_NO_CHANGE: ' + $Name)
                exit 0
              }

              # Update semantics: replace (remove + recreate) to apply new IP/secret/vendor
              Remove-NpsRadiusClient -Name $Name | Out-Null
              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor

              # Verify after update
              $check = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue
              if (-not $check) {
                Write-Output ('UPDATE_VERIFY_FAILED: ' + $Name)
                exit 1
              }

              Write-Output ('UPDATED: ' + $Name + ' (' + $IP + ')')
              exit 0
            }

            'delete' {
              if (-not $existing) {
                Write-Output ('MISSING_NO_CHANGE: ' + $Name)
                exit 0
              }

              Remove-NpsRadiusClient -Name $Name | Out-Null

              # Verify deletion
              $check = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue
              if ($check) {
                Write-Output ('DELETE_VERIFY_FAILED: ' + $Name)
                exit 1
              }

              Write-Output ('DELETED: ' + $Name)
              exit 0
            }

            default {
              Write-Output ('Invalid action: ' + $Action)
              exit 1
            }
          }
        }"
      register: nps_action
      changed_when: "'NO_CHANGE' not in nps_action.stdout"
      failed_when: nps_action.rc != 0

    - name: Display operation result
      debug:
        msg: "{{ nps_action.stdout_lines | default(['No output']) }}"
