- name: Manage NPS RADIUS client (single action) over SSH
  hosts: all
  gather_facts: no

  vars:
    ansible_user: "ansible-ssh"
    ansible_password: "Mission1990$"
    ansible_port: 22
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
    ansible_ssh_retries: 3
    ansible_shell_type: powershell
    ansible_become_method: runas
    ansible_become_user: "{{ ansible_user }}"

  vars:
    # Normalize survey inputs
    action_name: "{{ action_name | lower | trim }}"
    radius_client: "{{ radius_client | trim }}"
    ip_address: "{{ ip_address | default('') | trim }}"
    radius_vendor: "{{ radius_vendor | default('RADIUS Standard') | trim }}"

  tasks:
    - name: Validate action_name
      assert:
        that:
          - action_name in ['create', 'update', 'delete']
        fail_msg: "action_name must be one of: create, update, delete"

    - name: Validate required fields based on action
      assert:
        that:
          - radius_client != ''
          - action_name == 'delete' or ip_address != ''
          - action_name == 'delete' or (radius_secret is defined and (radius_secret | string | length) > 0)
        fail_msg: >
          Missing required fields. create/update require radius_client, ip_address, radius_secret.
          delete requires radius_client only.

   # Optional: prove PowerShell can run over SSH (useful for troubleshooting)
    - name: Confirm PowerShell execution over SSH
      ansible.windows.win_shell: >
        powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
        "$PSVersionTable.PSVersion.ToString()"
       register: ps_version
      changed_when: false

    - name: Show PowerShell version
      debug:
        var: ps_version.stdout

    - name: Apply NPS action (create/update/delete)
      ansible.windows.win_shell: >
        powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
        "& {
          $ErrorActionPreference = 'Stop';

          $Name   = {{ radius_client | to_json }};
          $Action = {{ action_name | to_json }};
          $IP     = {{ ip_address | to_json }};
          $Secret = {{ (radius_secret | default('')) | to_json }};
          $Vendor = {{ radius_vendor | to_json }};

          function New-Client {
            param($Name,$IP,$Secret,$Vendor)

            if ([string]::IsNullOrWhiteSpace($Vendor) -or $Vendor -eq 'RADIUS Standard') {
              New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret | Out-Null
            } else {
              New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -VendorName $Vendor | Out-Null
            }
          }

          $existing = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue

          switch ($Action) {

            'create' {
              if ($existing) {
                'EXISTS_NO_CHANGE: ' + $Name
                return
              }

              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor
              'CREATED: ' + $Name + ' (' + $IP + ')'
              return
            }

            'update' {
              if (-not $existing) {
                'MISSING_NO_CHANGE: ' + $Name
                return
              }

              # Update semantics: replace (remove + recreate) to apply new IP/secret/vendor
              Remove-NpsRadiusClient -Name $Name | Out-Null
              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor

              # Verify after update
              $check = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue
              if (-not $check) { throw ('UPDATE_VERIFY_FAILED: ' + $Name) }

              'UPDATED: ' + $Name + ' (' + $IP + ')'
              return
            }

            'delete' {
              if (-not $existing) {
                'MISSING_NO_CHANGE: ' + $Name
                return
              }

              Remove-NpsRadiusClient -Name $Name | Out-Null

              # Verify deletion
              $check = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue
              if ($check) { throw ('DELETE_VERIFY_FAILED: ' + $Name) }

              'DELETED: ' + $Name
              return
            }

            default {
              throw ('Invalid action: ' + $Action)
            }
          }
        }"
      register: nps_action
      no_log: false

    - name: Safe output summary
      debug:
        msg: "{{ nps_action.stdout }}"
 
