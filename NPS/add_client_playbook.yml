- name: Manage NPS RADIUS client (single action) over SSH
  hosts: nps_servers
  gather_facts: no

  vars:
    ansible_shell_type: powershell

    # Normalize/clean input
    action_name: "{{ action_name | lower | trim }}"
    radius_vendor: "{{ radius_vendor | default('RADIUS Standard') | trim }}"

  tasks:
    - name: Validate action_name
      assert:
        that:
          - action_name in ['create', 'update', 'delete']
        fail_msg: "action_name must be one of: create, update, delete"

    - name: Validate required fields based on action
      assert:
        that:
          - radius_client is defined and (radius_client | trim) != ''
          - action_name == 'delete' or (ip_address is defined and (ip_address | trim) != '')
          - action_name == 'delete' or (radius_secret is defined and (radius_secret | string | length) > 0)
        fail_msg: >
          Missing required fields. create/update require radius_client, ip_address, radius_secret.
          delete requires radius_client only.

    - name: Apply NPS action (create/update/delete)
      ansible.windows.win_shell: |
        $Name   = {{ radius_client | trim | to_json }}
        $Action = {{ action_name | to_json }}
        $IP     = {{ (ip_address | default('') | trim) | to_json }}
        $Secret = {{ (radius_secret | default('') ) | to_json }}
        $Vendor = {{ (radius_vendor | default('RADIUS Standard') | trim) | to_json }}

        $existing = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue

        switch ($Action) {

          "create" {
            if ($existing) {
              "EXISTS_NO_CHANGE: $Name"
              exit 0
            }

            if ([string]::IsNullOrWhiteSpace($Vendor) -or $Vendor -eq "RADIUS Standard") {
              New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -ErrorAction Stop | Out-Null
            } else {
              New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -VendorName $Vendor -ErrorAction Stop | Out-Null
            }

            "CREATED: $Name ($IP)"
          }

          "update" {
            if (-not $existing) {
              "MISSING_NO_CHANGE: $Name"
              exit 0
            }

            # Prefer Set-NpsRadiusClient if it exists; otherwise replace by delete+create.
            $setCmd = Get-Command Set-NpsRadiusClient -ErrorAction SilentlyContinue

            if ($setCmd) {
              if ([string]::IsNullOrWhiteSpace($Vendor) -or $Vendor -eq "RADIUS Standard") {
                Set-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -ErrorAction Stop | Out-Null
              } else {
                Set-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -VendorName $Vendor -ErrorAction Stop | Out-Null
              }
              "UPDATED: $Name ($IP)"
            } else {
              Remove-NpsRadiusClient -Name $Name -ErrorAction Stop | Out-Null
              if ([string]::IsNullOrWhiteSpace($Vendor) -or $Vendor -eq "RADIUS Standard") {
                New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -ErrorAction Stop | Out-Null
              } else {
                New-NpsRadiusClient -Name $Name -Address $IP -SharedSecret $Secret -VendorName $Vendor -ErrorAction Stop | Out-Null
              }
              "UPDATED_BY_RECREATE: $Name ($IP)"
            }
          }

          "delete" {
            if (-not $existing) {
              "MISSING_NO_CHANGE: $Name"
              exit 0
            }

            Remove-NpsRadiusClient -Name $Name -ErrorAction Stop | Out-Null

            # Verify deletion
            $check = Get-NpsRadiusClient -Name $Name -ErrorAction SilentlyContinue
            if ($check) {
              Write-Error "DELETE_VERIFY_FAILED: $Name still exists after removal"
              exit 1
            }

            "DELETED: $Name"
          }

          default {
            throw "Invalid action '$Action'"
          }
        }
      register: nps_action
      no_log: true

    - name: Show safe result summary
      debug:
        msg: "{{ nps_action.stdout }}"
      no_log: false
 
