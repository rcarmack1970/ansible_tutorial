# AWX-optimized version - credentials injected by AWX
- name: Manage NPS RADIUS client via SSH
  hosts: all
  gather_facts: no

  vars:
    # SSH Connection settings for Windows
    ansible_connection: ssh
    ansible_port: 22
    ansible_shell_type: powershell
    ansible_shell_executable: powershell.exe
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

    # AWX will inject ansible_user and ansible_ssh_private_key_file from the attached credential
    # No need to define them here - they come from AWX Resources -> Credentials

    # Normalize survey inputs
    action_name: "{{ action_name | lower | trim }}"
    radius_client: "{{ radius_client | trim }}"
    ip_address: "{{ ip_address | default('') | trim }}"
    radius_vendor: "{{ radius_vendor | default('RADIUS Standard') | trim }}"

  tasks:
    - name: Validate action_name
      assert:
        that:
          - action_name in ['create', 'update', 'delete']
        fail_msg: "action_name must be one of: create, update, delete"

    - name: Validate required fields based on action
      assert:
        that:
          - radius_client != ''
          - action_name == 'delete' or ip_address != ''
          - action_name == 'delete' or (radius_secret is defined and (radius_secret | string | length) > 0)
        fail_msg: >
          Missing required fields. create/update require radius_client, ip_address, radius_secret.
          delete requires radius_client only.

    - name: Apply NPS action (create/update/delete)
      ansible.windows.win_shell: |
        $ErrorActionPreference = 'Stop'

        $Name   = '{{ radius_client }}'
        $Action = '{{ action_name }}'
        $IP     = '{{ ip_address }}'
        $Secret = '{{ radius_secret | default('') }}'
        $Vendor = '{{ radius_vendor }}'

        # Import NPS module
        try {
          Import-Module NPS -ErrorAction Stop
        } catch {
          throw "NPS module not available. Is NPS role installed?"
        }

        function New-Client {
          param($Name, $IP, $Secret, $Vendor)

          $params = @{
            Name = $Name
            Address = $IP
            SharedSecret = $Secret
          }

          if (-not [string]::IsNullOrWhiteSpace($Vendor) -and $Vendor -ne 'RADIUS Standard') {
            $params['VendorName'] = $Vendor
          }

          New-NpsRadiusClient @params | Out-Null
        }

        # Check if client exists (Windows Server 2025 doesn't support -Name parameter)
        try {
          $allClients = Get-NpsRadiusClient -ErrorAction SilentlyContinue
          $existing = $allClients | Where-Object { $_.Name -eq $Name }
        } catch {
          $existing = $null
        }

        switch ($Action) {
          'create' {
            if ($existing) {
              Write-Output "EXISTS_NO_CHANGE: $Name"
              $Ansible.Changed = $false
            } else {
              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor
              Write-Output "CREATED: $Name ($IP)"
              $Ansible.Changed = $true
            }
          }

          'update' {
            if (-not $existing) {
              Write-Output "MISSING_NO_CHANGE: $Name"
              $Ansible.Changed = $false
            } else {
              # Update by removing and recreating - use netsh for Server 2025 compatibility
              try {
                $result = netsh nps delete client name="$Name" 2>&1
                $resultString = $result -join " "

                if (-not ($resultString -like "*Ok*" -or $resultString -like "*successfully*" -or $resultString -like "*not found*")) {
                  throw "netsh delete failed: $resultString"
                }
              } catch {
                throw "Failed to remove client for update: $_"
              }
              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor

              # Verify the update
              $allClientsAfter = Get-NpsRadiusClient -ErrorAction SilentlyContinue
              $check = $allClientsAfter | Where-Object { $_.Name -eq $Name }
              if (-not $check) {
                throw "UPDATE_VERIFY_FAILED: $Name"
              }

              Write-Output "UPDATED: $Name ($IP)"
              $Ansible.Changed = $true
            }
          }

          'delete' {
            if (-not $existing) {
              Write-Output "MISSING_NO_CHANGE: $Name"
              $Ansible.Changed = $false
            } else {
              # Use netsh for Windows Server 2025 compatibility
              try {
                $result = netsh nps delete client name="$Name" 2>&1
                $resultString = $result -join " "

                if ($resultString -like "*Ok*" -or $resultString -like "*successfully*") {
                  Write-Output "Client removed via netsh"
                } elseif ($resultString -like "*not found*" -or $resultString -like "*does not exist*") {
                  Write-Output "Client already removed"
                } else {
                  throw "netsh command failed: $resultString"
                }
              } catch {
                throw "Failed to remove client: $_"
              }

              # Verify deletion
              $allClientsAfter = Get-NpsRadiusClient -ErrorAction SilentlyContinue
              $check = $allClientsAfter | Where-Object { $_.Name -eq $Name }
              if ($check) {
                throw "DELETE_VERIFY_FAILED: $Name"
              }

              Write-Output "DELETED: $Name"
              $Ansible.Changed = $true
            }
          }

          default {
            throw "Invalid action: $Action"
          }
        }
      register: nps_action

    - name: Display operation result
      debug:
        var: nps_action.stdout_lines
