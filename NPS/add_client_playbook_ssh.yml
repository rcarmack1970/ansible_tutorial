# AWX-optimized version - credentials injected by AWX
- name: Manage NPS RADIUS client via SSH
  hosts: all
  gather_facts: no

  vars:
    # SSH Connection settings (OpenSSH on Windows)
    ansible_connection: ssh
    ansible_port: 22
    ansible_shell_type: powershell
    ansible_python_interpreter: none

    # Normalize survey inputs
    action_name: "{{ action_name | lower | trim }}"
    radius_client: "{{ radius_client | trim }}"
    ip_address: "{{ ip_address | default('') | trim }}"
    radius_vendor: "{{ radius_vendor | default('RADIUS Standard') | trim }}"

  tasks:
    - name: Validate action_name
      assert:
        that:
          - action_name in ['create', 'update', 'delete']
        fail_msg: "action_name must be one of: create, update, delete"

    - name: Validate required fields based on action
      assert:
        that:
          - radius_client != ''
          - action_name == 'delete' or ip_address != ''
          - action_name == 'delete' or (radius_secret is defined and (radius_secret | string | length) > 0)
        fail_msg: >
          Missing required fields. create/update require radius_client, ip_address, radius_secret.
          delete requires radius_client only.

    - name: Apply NPS action (create/update/delete) over SSH PowerShell
      ansible.builtin.raw: |
        powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass -EncodedCommand {{ ('
        $ErrorActionPreference = "Stop"

        $Name   = "' + radius_client + '"
        $Action = "' + action_name + '"
        $IP     = "' + ip_address + '"
        $Secret = "' + (radius_secret | default("")) + '"
        $Vendor = "' + radius_vendor + '"

        Import-Module NPS -ErrorAction Stop

        function New-Client {
          param($Name, $IP, $Secret, $Vendor)

          $params = @{
            Name         = $Name
            Address      = $IP
            SharedSecret = $Secret
          }

          if (-not [string]::IsNullOrWhiteSpace($Vendor) -and $Vendor -ne "RADIUS Standard") {
            $params["VendorName"] = $Vendor
          }

          New-NpsRadiusClient @params | Out-Null
        }

        $existing = Get-NpsRadiusClient -ErrorAction SilentlyContinue |
                    Where-Object { $_.Name -eq $Name }

        switch ($Action) {
          "create" {
            if ($existing) { Write-Output "EXISTS_NO_CHANGE"; exit 0 }
            New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor
            Write-Output "CREATED"
            exit 2
          }

          "update" {
            if (-not $existing) { Write-Output "MISSING_NO_CHANGE"; exit 0 }
            netsh nps delete client name="$Name" | Out-Null
            New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor
            Write-Output "UPDATED"
            exit 2
          }

          "delete" {
            if (-not $existing) { Write-Output "MISSING_NO_CHANGE"; exit 0 }
            netsh nps delete client name="$Name" | Out-Null
            Write-Output "DELETED"
            exit 2
          }
        }
        ') | encode_utf16le | b64encode }}
      register: nps_action
      changed_when: nps_action.rc == 2
      failed_when: nps_action.rc not in [0, 2]

    - name: Display operation result
      debug:
        msg: "{{ nps_action.stdout | default('No output') }}"
