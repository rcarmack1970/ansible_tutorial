    - name: Apply NPS action via raw PowerShell (EncodedCommand, AWX-safe)
      ansible.builtin.raw: >
        powershell.exe -NoProfile -NonInteractive -ExecutionPolicy Bypass
        -EncodedCommand {{ ps_encoded }}
      vars:
        ps_script: |
          $ErrorActionPreference = 'Stop'

          $Name   = "{{ radius_client }}"
          $Action = "{{ action_name }}"
          $IP     = "{{ ip_address }}"
          $Secret = "{{ radius_secret | default('') }}"
          $Vendor = "{{ radius_vendor }}"

          try {
            Import-Module NPS -ErrorAction Stop
          } catch {
            throw "NPS module not available. Is NPS role installed?"
          }

          function New-Client {
            param($Name, $IP, $Secret, $Vendor)

            $params = @{
              Name         = $Name
              Address      = $IP
              SharedSecret = $Secret
            }

            if (-not [string]::IsNullOrWhiteSpace($Vendor) -and $Vendor -ne 'RADIUS Standard') {
              $params['VendorName'] = $Vendor
            }

            New-NpsRadiusClient @params | Out-Null
          }

          $allClients = Get-NpsRadiusClient -ErrorAction SilentlyContinue
          $existing = $allClients | Where-Object { $_.Name -eq $Name }

          switch ($Action) {
            'create' {
              if ($existing) { Write-Output "EXISTS_NO_CHANGE"; exit 0 }
              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor
              Write-Output "CREATED"; exit 2
            }

            'update' {
              if (-not $existing) { Write-Output "MISSING_NO_CHANGE"; exit 0 }
              $out = netsh nps delete client name="$Name" 2>&1
              New-Client -Name $Name -IP $IP -Secret $Secret -Vendor $Vendor
              Write-Output "UPDATED"; exit 2
            }

            'delete' {
              if (-not $existing) { Write-Output "MISSING_NO_CHANGE"; exit 0 }
              $out = netsh nps delete client name="$Name" 2>&1
              Write-Output "DELETED"; exit 2
            }

            default { throw "Invalid action: $Action" }
          }
        # Encode as UTF-16LE Base64 for Windows PowerShell -EncodedCommand
        ps_encoded: "{{ ps_script | to_json | from_json | regex_replace('\\r?\\n', '\\r\\n') | b64encode(encoding='utf-16le') }}"
      register: nps_action
      changed_when: nps_action.rc == 2
      failed_when: nps_action.rc not in [0, 2]
 
