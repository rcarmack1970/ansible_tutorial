---
# AWX-optimized version - credentials injected by AWX
- name: Get all NPS RADIUS clients via SSH
  hosts: all
  gather_facts: no

  vars:
    # SSH Connection settings for Windows
    ansible_connection: ssh
    ansible_port: 22
    ansible_shell_type: powershell
    ansible_become_method: runas
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

    # PowerShell settings for SSH
    ansible_shell_executable: powershell.exe

    # Timeout settings (optional - increase if needed)
    ansible_ssh_timeout: 30

    # AWX will inject ansible_user and ansible_password from the attached credential
    # No need to define them here - they come from AWX Resources -> Credentials

  tasks:
    - name: Get all NPS RADIUS clients
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          # Import NPS module
          try {
            Import-Module NPS -ErrorAction Stop
          } catch {
            throw "NPS module not available. Is NPS role installed?"
          }

          # Get all RADIUS clients
          try {
            $clients = Get-NpsRadiusClient -ErrorAction Stop | Sort-Object Name

            if ($clients.Count -eq 0) {
              Write-Output "No RADIUS clients found on this NPS server."
              $Ansible.Changed = $false
              return
            }

            # Format output as one line per client
            $output = @()
            $output += "="*100
            $output += "NPS RADIUS Clients - Total: $($clients.Count) (sorted by name)"
            $output += "="*100
            $output += "{0,-30} {1,-20} {2,-25} {3,-10}" -f "Client Name", "IP Address", "Vendor", "Enabled"
            $output += "-"*100

            foreach ($client in $clients) {
              $line = "{0,-30} {1,-20} {2,-25} {3,-10}" -f $client.Name, $client.Address, $client.VendorName, $client.Enabled
              $output += $line
            }

            $output += "="*100
            $output | ForEach-Object { Write-Output $_ }
            $Ansible.Changed = $false

          } catch {
            throw "Failed to retrieve NPS clients: $_"
          }

      register: nps_clients

    - name: Display NPS clients
      debug:
        var: nps_clients.output

    - name: Export clients to JSON format
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'
          Import-Module NPS -ErrorAction Stop

          $clients = Get-NpsRadiusClient -ErrorAction Stop | Sort-Object Name

          # Create simplified object array
          $clientList = @()
          foreach ($client in $clients) {
            $clientList += @{
              Name = $client.Name
              Address = $client.Address
              Vendor = $client.VendorName
              Enabled = $client.Enabled
            }
          }

          # Convert to JSON
          $json = $clientList | ConvertTo-Json -Depth 3
          Write-Output $json

      register: nps_clients_json

    - name: Save JSON output
      debug:
        msg: "{{ nps_clients_json.output[0] }}"
