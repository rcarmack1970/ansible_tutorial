---
# AWX-optimized version - credentials injected by AWX
- name: Manage NPS RADIUS client via SSH
  hosts: all
  gather_facts: no

  vars:
    # SSH Connection settings for Windows
    ansible_connection: ssh
    ansible_port: 22
    ansible_shell_type: powershell
    ansible_become_method: runas
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

    # PowerShell settings for SSH
    ansible_shell_executable: powershell.exe

    # Timeout settings (optional - increase if needed)
    ansible_ssh_timeout: 30

    # AWX will inject ansible_user and ansible_password from the attached credential
    # No need to define them here - they come from AWX Resources -> Credentials

    # Normalize survey inputs
    radius_client: "{{ radius_client | trim }}"
    ip_address: "{{ ip_address | default('') | trim }}"
    radius_vendor: "{{ radius_vendor | default('RADIUS Standard') | trim }}"

  tasks:
    - name: Validate required fields based on action
      assert:
        that:
          - radius_client != ''
        fail_msg: >
          Missing required field. radius_client, ip_address, radius_secret.

    - name: Update NPS Client
      ansible.windows.win_powershell:
        script: |
          $ErrorActionPreference = 'Stop'

          $Name   = '{{ radius_client }}'
          $IP     = '{{ ip_address }}'
          $Secret = '{{ radius_secret | default('') }}'
          $Vendor = '{{ radius_vendor }}'

          # Import NPS module
          try {
            Import-Module NPS -ErrorAction Stop
          } catch {
            throw "NPS module not available. Is NPS role installed?"
          }

          # Check if client exists (Windows Server 2025 doesn't support -Name parameter)
          try {
            $allClients = Get-NpsRadiusClient -ErrorAction Stop
            $existing = $allClients | Where-Object { $_.Name -eq $Name }
          } catch {
            $existing = $null
          }


          if (-not $existing) {
             Write-Output "MISSING_NO_CHANGE: $Name"
             $Ansible.Changed = $false
           } else {
             # Update client using netsh (updates in place without deletion)
             # Build command dynamically - only include parameters that have values
             try {
               $cmd = "netsh nps set client name=`"$Name`""

               if ($IP -ne '') {
                 $cmd += " address=$IP"
               }

               if ($Secret -ne '') {
                 $cmd += " sharedsecret=$Secret"
               }

               if ($Vendor -ne '') {
                 $cmd += " vendor=`"$Vendor`""
               }

               $result = Invoke-Expression $cmd
               $resultString = $result -join " "

               if (-not ($resultString -like "*Ok*" -or $resultString -like "*successfully*")) {
                 throw "netsh set client failed: $resultString"
               }
             } catch {
               throw "Failed to update client: $_"
             }

             # Verify the update
             $allClientsAfter = Get-NpsRadiusClient -ErrorAction SilentlyContinue
             $check = $allClientsAfter | Where-Object { $_.Name -eq $Name }
             if (-not $check) {
               throw "UPDATE_VERIFY_FAILED: $Name"
             }

             # Build result message showing what was updated
             $updatedFields = @()
             if ($IP -ne '') { $updatedFields += "IP=$IP" }
             if ($Secret -ne '') { $updatedFields += "Secret=***" }
             if ($Vendor -ne '') { $updatedFields += "Vendor=$Vendor" }

             $updateMsg = if ($updatedFields.Count -gt 0) {
               "UPDATED: $Name (" + ($updatedFields -join ", ") + ")"
             } else {
               "NO_CHANGES: $Name (no parameters provided)"
             }

             Write-Output $updateMsg
             $Ansible.Changed = ($updatedFields.Count -gt 0)
          }
          
      register: nps_action

    - name: Display operation result
      debug:
        var: nps_action.output
